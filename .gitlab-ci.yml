stages:
  - build
  - appium

variables:
  LANG: "en_US.UTF-8"
  LC_ALL: "en_US.UTF-8"
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: "120"

.cache:
  key:
    files:
      - Gemfile.lock
      - Podfile.lock
  paths:
    - ~/.bundle
    - ~/.gem

build:
  stage: build
  script:
    - fastlane full_pipeline
    - pwd
    - ls -al
  artifacts:
    paths:
      - "build/CounterApp.app"
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  tags:
    - thj-mac-m1-runner

.local:appium:
  stage: appium
  script:
    - pwd
    - ls -al
    - fastlane local_appium
  needs:
    - build
  tags:
    - thj-mac-m1-runner

gitlab:appium:
  stage: appium
  script:
    - mv build/CounterApp.app CounterApp.app

    # 프로젝트마다 변경 필요
    - export IP_APP="../CounterApp.app"
    - export IP_PLATFORM="iOS"
    - export IP_DEVICE_NAME="iPhone 16 Pro"
    - export IP_PLATFORM_VERSION="18.2"
    - export IP_APPIUM_HOST="127.0.0.1"
    - export IP_APPIUM_PORT="4723"
    - export IP_AUTOMATION_NAME="XCUITest"
    - export IP_MAX_RETRIES="3"
    #

    - fastlane gitlab_appium
  needs:
    - job: build
      artifacts: true # build 단계에서 생성한 아티팩트 사용 (자동 다운로드)
  tags:
    - thj-mac-m1-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
