stages:
  - build
  - appium

variables:
  LANG: "en_US.UTF-8"
  LC_ALL: "en_US.UTF-8"
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: "120"

.cache:
  key:
    files:
      - Gemfile.lock
      - Podfile.lock
  paths:
    - ~/.bundle
    - ~/.gem

build:
  stage: build
  script:
    - fastlane full_pipeline
    - pwd
    - ls -al
  artifacts:
    paths:
      - "build/CounterApp.app"
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  tags:
    - thj-mac-m1-runner

.local:appium:
  stage: appium
  script:
    - pwd
    - ls -al
    - fastlane local_appium
  needs:
    - build
  tags:
    - thj-mac-m1-runner

gitlab:appium:
  stage: appium
  before_script:
    - export NVM_DIR="$HOME/.nvm"
    - source "$NVM_DIR/nvm.sh"
    - nvm install 22
    - nvm use 22
    - echo "export NVM_DIR=\"$HOME/.nvm\"" >> ~/.bashrc
    - echo "source \"$NVM_DIR/nvm.sh\"" >> ~/.bashrc
    - echo "nvm use 22" >> ~/.bashrc
    - node -v  # âœ… í˜„ì¬ Node.js ë²„ì „ í™•ì¸
    - cd appium  # Appium í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
    - npm install  # âœ… ëª¨ë“ˆ ì„¤ì¹˜
  script:
    - source ~/.bashrc  # âœ… NVM í™˜ê²½ ê°•ì œ ë¡œë“œ
    - node -v  # âœ… ë‹¤ì‹œ í˜„ì¬ Node.js ë²„ì „ í™•ì¸ (22ê°€ ì¶œë ¥ë¼ì•¼ í•¨)
    - cd ..

    # í”„ë¡œì íŠ¸ë§ˆë‹¤ ë³€ê²½ í•„ìš”
    - export IP_APP="build/CounterApp.app"
    - export IP_PLATFORM="iOS"
    - export IP_DEVICE_NAME="iPhone 16 Pro"
    - export IP_PLATFORM_VERSION="18.2"
    - export IP_APPIUM_HOST="127.0.0.1"
    - export IP_APPIUM_PORT="4723"
    - export IP_AUTOMATION_NAME="XCUITest"
    - export IP_MAX_RETRIES="1"
    #

    - fastlane gitlab_appium

    # loki
    - |
      echo "ğŸ“Œ Appium ë¡œê·¸ë¥¼ Lokië¡œ ì „ì†¡ ì¤‘..."
      curl -X POST "https://loki.devops.cj.net/loki/api/v1/push" \
        -H "Content-Type: application/json" \
        -d @<(jq -n --arg log "$(cat test-results.log | base64)" '
          {
            "streams": [
              {
                "stream": {"app": "appium-test"},
                "values": [ [(now | todateiso8601), $log] ]
              }
            ]
          }')
  needs:
    - job: build
      artifacts: true # build ë‹¨ê³„ì—ì„œ ìƒì„±í•œ ì•„í‹°íŒ©íŠ¸ ì‚¬ìš© (ìë™ ë‹¤ìš´ë¡œë“œ)
  tags:
    - thj-mac-m1-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
