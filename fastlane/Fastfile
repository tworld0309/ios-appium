default_platform(:ios)

platform :ios do
  desc "Build iOS app without signing"
  lane :build do
    # Xcode ë¹Œë“œ ì„¤ì •
    gym(
      scheme: "CounterApp",
      project: "CounterApp.xcodeproj",
      output_directory: "./build",
      output_name: "CounterApp.app",
      clean: true,
      sdk: "iphonesimulator",  # âœ… ì‹œë®¬ë ˆì´í„° ë¹Œë“œ
      skip_package_ipa: true,  # âœ… IPA íŒ¨í‚¤ì§• ê±´ë„ˆë›°ê¸°
      skip_codesigning: true,  # âœ… ì½”ë“œ ì„œëª… ì™„ì „ ë¹„í™œì„±í™”
      archive_path: "./build/CounterApp.xcarchive", # ì•„ì¹´ì´ë¸Œ ì €ì¥ ê²½ë¡œ ë³€ê²½
      destination: "generic/platform=iOS Simulator", # âœ… ì‹œë®¬ë ˆì´í„° íƒ€ê²Ÿ
      derived_data_path: "./build/DerivedData" # âœ… ë¹Œë“œ ì‚°ì¶œë¬¼ì„ íŠ¹ì • ë””ë ‰í† ë¦¬ë¡œ ì§€ì •
    )
  end

  desc "Move CounterApp.app to ./build"
  lane :move_app do
    build_dir = "#{Dir.pwd}/../build" # fastlane í´ë” ê¸°ì¤€ìœ¼ë¡œ í•œ ë‹¨ê³„ ìœ„ì˜ build í´ë”
    sh "ls -al #{build_dir}"
    sh "ls -al #{build_dir}/DerivedData/Build/Intermediates.noindex/ArchiveIntermediates/CounterApp/BuildProductsPath/Release-iphonesimulator"

    # âœ… DerivedDataì—ì„œ .app ì°¾ê¸°
    app_path = Dir.glob("#{build_dir}/DerivedData/Build/Intermediates.noindex/ArchiveIntermediates/CounterApp/BuildProductsPath/Release-iphonesimulator/CounterApp.app").first
    UI.message("ğŸ” Searching app in DerivedData: #{app_path}")

    
    if app_path && File.exist?(app_path)
      sh "cp -r #{app_path} ./build/CounterApp.app"
      UI.message("âœ… CounterApp.app has been moved to ./build/")
    else
      UI.error("âŒ CounterApp.app not found in DerivedData")
    end
  end

  # desc "Upload CounterApp.app to S3"
  # lane :upload_to_s3 do
  #   s3_bucket = "your-s3-bucket-name" # ğŸ‘‰ ì—¬ê¸° S3 ë²„í‚· ì´ë¦„ ì…ë ¥
  #   s3_path = "s3://#{s3_bucket}/CounterApp.app"
    
  #   if File.exist?("./build/CounterApp.app")
  #     sh "aws s3 cp ./build/CounterApp.app #{s3_path}"
  #     UI.message("âœ… CounterApp.app uploaded to S3: #{s3_path}")
  #   else
  #     UI.error("âŒ CounterApp.app not found in ./build/")
  #   end
  # end

  desc "Run Appium tests on iOS Simulator"
  lane :run_appium_tests do
    UI.message("ğŸš€ Running Appium tests...")

    # âœ… Appium í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Node.js í™˜ê²½ì—ì„œ ì‹¤í–‰)
    sh "../5-test-appium.sh"

    UI.message("âœ… Appium tests completed!")
  end

  desc "Run full build pipeline (Build â†’ Move â†’ Upload)"
  lane :full_pipeline do
    build
    move_app
    #upload_to_s3
  end
end